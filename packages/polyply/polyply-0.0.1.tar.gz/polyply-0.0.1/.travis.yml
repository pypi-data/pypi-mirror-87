language: python
dist: xenial
cache: pip

branches:
  only:
  - master
  - /^v(?<major>0|[1-9]\d*)\.(?<minor>0|[1-9]\d*)\.(?<patch>0|[1-9]\d*)(?:-(?<prerelease>(?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\.(?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\+(?<buildmetadata>[0-9a-zA-Z-]+(?:\.[0-9a-zA-Z-]+)*))?$/ # SemVer tags (https://github.com/semver/semver/issues/232#issuecomment-405596809)

env:
  global:
    - SKIP_GENERATE_AUTHORS=1
    - SKIP_WRITE_GIT_CHANGELOG=1
  matrix:
    WITH_CODECOV=true
before_install:
  - pip install --upgrade setuptools pip
install:
  # this is needed because polyply at the moment only works with the vermouth
  # dev version
  - pip install git+https://github.com/marrink-lab/vermouth-martinize.git#vermouth
  - pip install --upgrade .
before_script:
  - pip install --upgrade -r requirements-tests.txt
script:
  - coverage run --source=polyply $(which pytest) -vv polyply
after_success:
  - coverage report --omit='*/bin/pytest'
  - if [[ ${WITH_CODECOV} == true ]]; then codecov; fi

jobs:
  fast_finish: true
  allow_failures:
    - python: "3.6-dev"
    - python: "3.7-dev"
    - python: "3.8-dev"
  include:
    - python: "3.6"
    - python: "3.7"
    - python: "3.8"
    - python: "3.6-dev"
    - python: "3.7-dev"
    - python: "3.8-dev"
      env: WITH_CODECOV=false

#   - stage: docs
#     python: "3.7"
#     install:
#       - pip install --upgrade -r requirements-docs.txt
#       - pip install --upgrade .[full]
#     # script: python setup.py build_sphinx
#     script: mkdir -p doc/source/_static; sphinx-build -EnW -b html doc/source/ doc/build/html
#     after_success: skip

    - stage: pylint
      python: "3.7"
      install:
        # for now we need development version
        - pip install git+https://github.com/marrink-lab/vermouth-martinize.git#vermouth
        - pip install --upgrade -r requirements-tests.txt
        - pip install pylint
      script:
        - python run_pylint.py --disable=fixme --fail-under=8.0 polyply
        - python run_pylint.py --disable=fixme --fail-under=9.5 bin/polyply
      after_success: skip

    - stage: deploy
      python: "3.7"
      addons: skip
      env: WITH_CODECOV=false
      before_script: skip
      script: skip
      deploy:
          provider: pypi
          user: __token__
          password:
              # travis encrypt --add deploy.password
              secure: "vP6rUEbSrqYJmqcp37cH2YNfBik3nQHs0/jqop0m75wph95lumRQqp0xVlPoM4yBEHvfjcOqTeq9Ixz4lMmouYedcGu8nrjbWu/LzWWle55ETpVsQ4Sjld/Mui9GBIK802GHiIC0fTTf0f/u/MxrhE2l7vBGp3lCRn/9zIlHOiFZn+Iu+A5sQfuyUu8taY0xOzSobnn/1m7Ve11enm7TfQN0sK6EtJuK/zWSCuExoxe3DHAqglfOniHXyaCxTfGxrgwpSAbRH0Yo34Q4ko78ZBNuEFqHGiHg4oBJ74blLPDwfwyvTPZqnsbthE/kx/4GcuVx7Trod9jIvK+kzohijIMTXA8Ew1RwigCtLhvLFaJklOXmbZEZ6nM5RY8KRbE5neFeRH7VvN0GspLzkue3ZW7XIT6bcomu6MMqAc0FNi6Dl41iPC9KvcntpdFJgAXnJztGA75TnpxE0awxMAA80RneCi4oHIpg6bE3giQyxmAVZj21WxySUzKrYYjsk1NYVVtgV+YzJ3KmI5iTG0URe5GdeihZICBgBrwG56zdoD9SZcfFBM+PEcT8YhSvkif9E3F4BM8sxOYHRf7BiC89DGV4ZJa9skjQ4YMpO1G/aIdzvUBfTOuuKQ/IshI/KOzzokIsjIhRF4gr1Zfvog06RH4IbmDCXzdYYCAVeMLiDlE="
          on:
              tags: true
