{"version":3,"file":"wsrpc.js","sources":["../wsrpc.es6.js"],"sourcesContent":["class Deferred {\n\tconstructor() {\n\t\tconst self = this;\n\n\t\tself.resolve = null;\n\t\tself.reject = null;\n\t\tself.done = false;\n\n\t\tfunction wrapper(func) {\n\t\t\treturn function () {\n\t\t\t\tif (self.done) throw new Error('Promise already done');\n\t\t\t\tself.done = true;\n\t\t\t\treturn func.apply(this, arguments);\n\t\t\t}\n\t\t}\n\n\t\tself.promise = new Promise(\n\t\t\t(resolve, reject) => {\n\t\t\t\tself.resolve = wrapper(resolve);\n\t\t\t\tself.reject = wrapper(reject);\n\t\t\t}\n\t\t);\n\n\t\tself.promise.isPending = () => { return !self.done };\n\t\treturn self;\n\t}\n}\n\nfunction logGroup(group, level, args) {\n\tconsole.group(group);\n\tconsole[level].apply(this, args);\n\tconsole.groupEnd();\n}\n\nfunction log() {\n\tif (!WSRPC.DEBUG) return;\n\tlogGroup('WSRPC.DEBUG', 'trace', arguments);\n}\n\nfunction trace (msg) {\n\tif (!WSRPC.TRACE) return;\n\n\tvar payload = msg;\n\tif ('data' in msg) payload = JSON.parse(msg.data);\n\tlogGroup(\"WSRPC.TRACE\", 'trace', [payload]);\n}\n\nfunction getAbsoluteWsUrl(url) {\n\tif ((/^\\w+:\\/\\//).test(url)) return url;\n\tif (typeof window == 'undefined' && window.location.host.length < 1)\n\t\tthrow new Error(\n\t\t\t`Can not construct absolute URL from ${window.location}`\n\t\t);\n\tconst scheme = window.location.protocol === \"https:\" ? \"wss:\" : \"ws:\";\n\tconst port = window.location.port === '' ? `:${window.location.port}` : '';\n\tconst host = window.location.host;\n\tconst path = url.replace(/^\\/+/gm, '');\n\treturn `${scheme}//${host}${port}/${path}`;\n}\n\nconst readyState = Object.freeze({\n\t0: 'CONNECTING',\n\t1: 'OPEN',\n\t2: 'CLOSING',\n\t3: 'CLOSED'\n});\n\nclass WSRPC {\n\tconstructor (URL, reconnectTimeout = 1000) {\n\t\tvar self = this;\n\n\t\tURL = getAbsoluteWsUrl(URL);\n\n\t\tself.id = 1;\n\t\tself.eventId = 0;\n\t\tself.socketStarted = false;\n\t\tself.eventStore = {\n\t\t\tonconnect: {},\n\t\t\tonerror: {},\n\t\t\tonclose: {},\n\t\t\tonchange: {}\n\t\t};\n\t\tself.connectionNumber = 0;\n\t\tself.oneTimeEventStore = {\n\t\t\tonconnect: [],\n\t\t\tonerror: [],\n\t\t\tonclose: [],\n\t\t\tonchange: []\n\t\t};\n\n\t\tself.callQueue = [];\n\n\t\tfunction createSocket() {\n\t\t\tvar ws = new WebSocket(URL);\n\n\t\t\tvar rejectQueue = function () {\n\t\t\t\tself.connectionNumber++; // rejects incoming calls\n\t\t\t\tvar deferred;\n\n\t\t\t\t//reject all pending calls\n\t\t\t\twhile (0 < self.callQueue.length) {\n\t\t\t\t\tvar callObj = self.callQueue.shift();\n\t\t\t\t\tdeferred = self.store[callObj.id];\n\t\t\t\t\tdelete self.store[callObj.id];\n\n\t\t\t\t\tif (deferred && deferred.promise.isPending()) {\n\t\t\t\t\t\tdeferred.reject('WebSocket error occurred');\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// reject all from the store\n\t\t\t\tfor (var key in self.store) {\n\t\t\t\t\tif (!self.store.hasOwnProperty(key)) continue;\n\n\t\t\t\t\tdeferred = self.store[key];\n\t\t\t\t\tif (deferred && deferred.promise.isPending()) {\n\t\t\t\t\t\tdeferred.reject('WebSocket error occurred');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tfunction reconnect(callEvents) {\n\t\t\t\tsetTimeout(function () {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tself.socket = createSocket();\n\t\t\t\t\t\tself.id = 1;\n\t\t\t\t\t} catch (exc) {\n\t\t\t\t\t\tcallEvents('onerror', exc);\n\t\t\t\t\t\tdelete self.socket;\n\t\t\t\t\t\tconsole.error(exc);\n\t\t\t\t\t}\n\t\t\t\t}, reconnectTimeout);\n\t\t\t}\n\n\t\t\tws.onclose = function (err) {\n\t\t\t\tlog('ONCLOSE CALLED', 'STATE', self.public.state());\n\t\t\t\ttrace(err);\n\n\t\t\t\tfor (var serial in self.store) {\n\t\t\t\t\tif (!self.store.hasOwnProperty(serial)) continue;\n\t\t\t\t\tif (self.store[serial].hasOwnProperty('reject')) {\n\t\t\t\t\t\tself.store[serial].reject('Connection closed');\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\trejectQueue();\n\t\t\t\tcallEvents('onclose', err);\n\t\t\t\tcallEvents('onchange', err);\n\t\t\t\treconnect(callEvents);\n\t\t\t};\n\n\t\t\tws.onerror = function (err) {\n\t\t\t\tlog('ONERROR CALLED', 'STATE', self.public.state());\n\t\t\t\ttrace(err);\n\n\t\t\t\trejectQueue();\n\t\t\t\tcallEvents('onerror', err);\n\t\t\t\tcallEvents('onchange', err);\n\n\t\t\t\tlog('WebSocket has been closed by error: ', err);\n\t\t\t};\n\n\t\t\tfunction tryCallEvent(func, event) {\n\t\t\t\ttry {\n\t\t\t\t\treturn func(event);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tif (e.hasOwnProperty('stack')) {\n\t\t\t\t\t\tlog(e.stack);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tlog('Event function', func, 'raised unknown error:', e);\n\t\t\t\t\t}\n\t\t\t\t\tconsole.error(e);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfunction callEvents(evName, event) {\n\t\t\t\twhile (0 < self.oneTimeEventStore[evName].length) {\n\t\t\t\t\tvar deferred = self.oneTimeEventStore[evName].shift();\n\t\t\t\t\tif (deferred.hasOwnProperty('resolve') &&\n\t\t\t\t\t\tdeferred.promise.isPending()) deferred.resolve();\n\t\t\t\t}\n\n\t\t\t\tfor (var i in self.eventStore[evName]) {\n\t\t\t\t\tif (!self.eventStore[evName].hasOwnProperty(i)) continue;\n\t\t\t\t\tvar cur = self.eventStore[evName][i];\n\t\t\t\t\ttryCallEvent(cur, event);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tws.onopen = function (ev) {\n\t\t\t\tlog('ONOPEN CALLED', 'STATE', self.public.state());\n\t\t\t\ttrace(ev);\n\n\t\t\t\twhile (0 < self.callQueue.length) {\n\t\t\t\t\t// noinspection JSUnresolvedFunction\n\t\t\t\t\tself.socket.send(JSON.stringify(self.callQueue.shift(), 0, 1));\n\t\t\t\t}\n\n\t\t\t\tcallEvents('onconnect', ev);\n\t\t\t\tcallEvents('onchange', ev);\n\t\t\t};\n\n\t\t\tfunction handleCall(self, data) {\n\t\t\t\tif (!self.routes.hasOwnProperty(data.method))\n\t\t\t\t\tthrow new Error('Route not found');\n\n\t\t\t\tvar connectionNumber = self.connectionNumber;\n\t\t\t\tvar deferred = new Deferred();\n\n\t\t\t\tdeferred.promise.then(\n\t\t\t\t\tfunction (result) {\n\t\t\t\t\t\tif (connectionNumber !== self.connectionNumber) return;\n\t\t\t\t\t\tself.socket.send(JSON.stringify({\n\t\t\t\t\t\t\tid: data.id,\n\t\t\t\t\t\t\tresult: result\n\t\t\t\t\t\t}));\n\t\t\t\t\t},\n\t\t\t\t\tfunction (error) {\n\t\t\t\t\t\tif (connectionNumber !== self.connectionNumber) return;\n\t\t\t\t\t\tself.socket.send(JSON.stringify({\n\t\t\t\t\t\t\tid: data.id,\n\t\t\t\t\t\t\terror: error\n\t\t\t\t\t\t}));\n\t\t\t\t\t}\n\t\t\t\t);\n\n\t\t\t\tvar func = self.routes[data.method];\n\n\t\t\t\tif (self.asyncRoutes[data.method])\n\t\t\t\t\treturn func.apply(deferred, [data.params]);\n\n\t\t\t\tfunction badPromise() {\n\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t\"You should register route with async flag.\"\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tvar promiseMock = {\n\t\t\t\t\tresolve: badPromise,\n\t\t\t\t\treject: badPromise,\n\t\t\t\t};\n\n\t\t\t\ttry {\n\t\t\t\t\tdeferred.resolve(func.apply(promiseMock, [data.params]));\n\t\t\t\t} catch (e) {\n\t\t\t\t\tdeferred.reject(e);\n\t\t\t\t\tconsole.error(e);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfunction handleError(self, data) {\n\t\t\t\tif (!self.store.hasOwnProperty(data.id))\n\t\t\t\t\treturn log('Unknown callback');\n\n\t\t\t\tvar deferred = self.store[data.id];\n\n\t\t\t\tif (typeof deferred === 'undefined')\n\t\t\t\t\treturn log('Confirmation without handler');\n\n\t\t\t\tdelete self.store[data.id];\n\t\t\t\tlog('REJECTING', data.error);\n\t\t\t\tdeferred.reject(data.error);\n\t\t\t}\n\n\t\t\tfunction handleResult(self, data) {\n\t\t\t\tvar deferred = self.store[data.id];\n\t\t\t\tif (typeof deferred === 'undefined')\n\t\t\t\t\treturn log('Confirmation without handler');\n\n\t\t\t\tdelete self.store[data.id];\n\n\t\t\t\tif (data.hasOwnProperty('result')) {\n\t\t\t\t\treturn deferred.resolve(data.result);\n\t\t\t\t}\n\t\t\t\treturn deferred.reject(data.error);\n\t\t\t}\n\n\t\t\tws.onmessage = function (message) {\n\t\t\t\tlog('ONMESSAGE CALLED', 'STATE', self.public.state());\n\t\t\t\ttrace(message);\n\n\t\t\t\tif (message.type !== 'message') return;\n\n\t\t\t\tvar data;\n\n\t\t\t\ttry {\n\t\t\t\t\tdata = JSON.parse(message.data);\n\t\t\t\t\tlog(data);\n\t\t\t\t\tif (data.hasOwnProperty('method')) {\n\t\t\t\t\t\treturn handleCall(self, data);\n\t\t\t\t\t} else if (data.hasOwnProperty('error') && data.error === null) {\n\t\t\t\t\t\treturn handleError(self, data);\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn handleResult(self, data);\n\t\t\t\t\t}\n\t\t\t\t} catch (exception) {\n\t\t\t\t\tvar err = {\n\t\t\t\t\t\terror: exception.message,\n\t\t\t\t\t\tresult: null,\n\t\t\t\t\t\tid: data ? data.id : null\n\t\t\t\t\t};\n\n\t\t\t\t\tself.socket.send(JSON.stringify(err));\n\t\t\t\t\tconsole.error(exception);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\treturn ws;\n\t\t}\n\n\t\tfunction makeCall(func, args, params) {\n\t\t\tself.id += 2;\n\t\t\tvar deferred = new Deferred();\n\n\t\t\tvar callObj = Object.freeze({\n\t\t\t\tid: self.id,\n\t\t\t\tmethod: func,\n\t\t\t\tparams: args\n\t\t\t});\n\n\t\t\tvar state = self.public.state();\n\n\t\t\tif (state === 'OPEN') {\n\t\t\t\tself.store[self.id] = deferred;\n\t\t\t\tself.socket.send(JSON.stringify(callObj));\n\t\t\t} else if (state === 'CONNECTING') {\n\t\t\t\tlog('SOCKET IS', state);\n\t\t\t\tself.store[self.id] = deferred;\n\t\t\t\tself.callQueue.push(callObj);\n\t\t\t} else {\n\t\t\t\tlog('SOCKET IS', state);\n\t\t\t\tif (params && params['noWait']) {\n\t\t\t\t\tdeferred.reject(`Socket is: ${state}`);\n\t\t\t\t} else {\n\t\t\t\t\tself.store[self.id] = deferred;\n\t\t\t\t\tself.callQueue.push(callObj);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn deferred.promise;\n\t\t}\n\n\t\tself.asyncRoutes = {};\n\t\tself.routes = {};\n\t\tself.store = {};\n\t\tself.public = Object.freeze({\n\t\t\tcall: function (func, args, params) {\n\t\t\t\treturn makeCall(func, args, params);\n\t\t\t},\n\t\t\taddRoute: function (route, callback, isAsync) {\n\t\t\t\tself.asyncRoutes[route] = isAsync || false;\n\t\t\t\tself.routes[route] = callback;\n\t\t\t},\n\t\t\tdeleteRoute: function (route) {\n\t\t\t\tdelete self.asyncRoutes[route];\n\t\t\t\treturn delete self.routes[route];\n\t\t\t},\n\t\t\taddEventListener: function (event, func) {\n\t\t\t\tvar eventId = self.eventId++;\n\t\t\t\tself.eventStore[event][eventId] = func;\n\t\t\t\treturn eventId;\n\t\t\t},\n\t\t\tremoveEventListener: function (event, index) {\n\t\t\t\tif (self.eventStore[event].hasOwnProperty(index)) {\n\t\t\t\t\tdelete self.eventStore[event][index];\n\t\t\t\t\treturn true;\n\t\t\t\t} else {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t},\n\t\t\tonEvent: function (event) {\n\t\t\t\tvar deferred = new Deferred();\n\t\t\t\tself.oneTimeEventStore[event].push(deferred);\n\t\t\t\treturn deferred.promise;\n\t\t\t},\n\t\t\tdestroy: function () {\n\t\t\t\treturn self.socket.close();\n\t\t\t},\n\t\t\tstate: function () {\n\t\t\t\treturn readyState[this.stateCode()];\n\t\t\t},\n\t\t\tstateCode: function () {\n\t\t\t\tif (self.socketStarted && self.socket)\n\t\t\t\t\treturn self.socket.readyState;\n\t\t\t\treturn 3;\n\t\t\t},\n\t\t\tconnect: function () {\n\t\t\t\tself.socketStarted = true;\n\t\t\t\tself.socket = createSocket();\n\t\t\t}\n\t\t});\n\n\t\tself.public.addRoute('log', function (argsObj) {\n\t\t\tconsole.info(`Websocket sent: ${argsObj}`);\n\t\t});\n\n\t\tself.public.addRoute('ping', function (data) {\n\t\t\treturn data;\n\t\t});\n\n\t\treturn self.public;\n\t}\n}\n\nWSRPC.DEBUG = false;\nWSRPC.TRACE = false;\n\nexport default WSRPC;\n"],"names":["Deferred","self","resolve","reject","done","wrapper","func","Error","apply","arguments","promise","Promise","isPending","logGroup","group","level","args","console","groupEnd","log","WSRPC","DEBUG","trace","msg","TRACE","payload","JSON","parse","data","getAbsoluteWsUrl","url","test","window","location","host","length","scheme","protocol","port","path","replace","readyState","Object","freeze","URL","reconnectTimeout","id","eventId","socketStarted","eventStore","onconnect","onerror","onclose","onchange","connectionNumber","oneTimeEventStore","callQueue","createSocket","ws","WebSocket","rejectQueue","deferred","callObj","shift","store","key","hasOwnProperty","reconnect","callEvents","setTimeout","socket","exc","error","err","public","state","serial","tryCallEvent","event","e","stack","evName","i","cur","onopen","ev","send","stringify","handleCall","routes","method","then","result","asyncRoutes","params","badPromise","promiseMock","handleError","handleResult","onmessage","message","type","exception","makeCall","push","call","addRoute","route","callback","isAsync","deleteRoute","addEventListener","removeEventListener","index","onEvent","destroy","close","stateCode","connect","argsObj","info"],"mappings":"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"}