[pytest]
addopts = --tb=short

[tox]
envlist = py36,py37,py38
skipsdist = true

[testenv]
passenv = *
install_command = pip install {opts} {packages}
commands =
    coverage run -m pytest tests {posargs}
    coverage xml -i -o coverage.{envname}.xml
deps=
    -rrequirements.txt
    .[all]
docker =
    influx
    elasticsearch
    zookeeper
    kafka

[docker:influx]
image = tutum/influxdb:0.8.8
ports =
    8086:8086/tcp
    8083:8083/tcp
    4444:4444/udp
environment =
    PRE_CREATE_DB=metrics
    UDP_DB=metrics
healthcheck_cmd = nc -w1 -z 127.0.0.1 8086
healthcheck_timeout = 1
healthcheck_retries = 5
healthcheck_interval = 3
healthcheck_start_period = 1

[docker:elasticsearch]
image = elasticsearch:6.8.5
ports =
    9200:9200/tcp
healthcheck_cmd = nc -w1 -z 127.0.0.1 9200
healthcheck_timeout = 5
healthcheck_retries = 100
healthcheck_interval = 5
healthcheck_start_period = 60

[docker:zookeeper]
image = confluentinc/cp-zookeeper:6.0.0
environment =
    ZOOKEEPER_CLIENT_PORT=2181
ports =
    2181:2181/tcp

[docker:kafka]
image = confluentinc/cp-kafka:6.0.0
ports =
    9092:9092/tcp
environment:
    KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
    KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://127.0.0.1:9092
    KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181
links:
    zookeeper
healthcheck_cmd = cub kafka-ready -b 127.0.0.1:9092 1 1
healthcheck_timeout = 5
healthcheck_retries = 50
healthcheck_interval = 3
healthcheck_start_period = 5
