version: '3'
services:
  train:
    image: example-container-cpu-py36
    volumes:
      - ../../secrets/sandbox3-292718-c2f74b1667f4.json:/opt/program/src/sagify_base/secrets/sandbox3-292718-c2f74b1667f4.json
    environment:
      SM_CHANNEL_LOOKUP: gs://staging-recommendation/find-local/test-client/data/train/lookup
      SM_CHANNEL_DETAIL: gs://staging-recommendation/find-local/test-client/data/train/detail
      # SM_CHANNEL_RESNET: gs://staging-recommendation/find-local/test-client/models/resnet34
      SM_MODEL_DIR: gs://staging-recommendation/find-local/test-client/models/model
      SM_OUTPUT_DATA_DIR: gs://staging-recommendation/find-local/test-client/models/output_data_dir
      GOOGLE_APPLICATION_CREDENTIALS: /opt/program/src/sagify_base/secrets/sandbox3-292718-c2f74b1667f4.json
    command: python src/sagify_base/training/train.py
    entrypoint: ["src/sagify_base/training/executor.sh"]
  deploy:
    image: example-container-cpu-py36
    volumes:
      - ../../secrets/sandbox3-292718-c2f74b1667f4.json:/opt/program/src/sagify_base/secrets/sandbox3-292718-c2f74b1667f4.json
    environment:
      SM_CHANNEL_LOOKUP: gs://staging-recommendation/find-local/test-client/data/train/lookup
      SM_CHANNEL_DETAIL: gs://staging-recommendation/find-local/test-client/data/train/detail
      # SM_CHANNEL_RESNET: gs://staging-recommendation/find-local/test-client/models/resnet34
      SM_MODEL_DIR: gs://staging-recommendation/find-local/test-client/models/model
      GOOGLE_APPLICATION_CREDENTIALS: /opt/program/src/sagify_base/secrets/sandbox3-292718-c2f74b1667f4.json
    command: python src/sagify_base/prediction/serve.py
    entrypoint: ["src/sagify_base/prediction/executor.sh"]
    ports:
      - "8080:8080"