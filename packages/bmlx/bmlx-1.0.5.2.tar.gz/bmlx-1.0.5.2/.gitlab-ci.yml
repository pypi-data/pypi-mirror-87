variables:
  image: "harbor.bigo.sg/mlplat/docker:latest"

stages: 
  - test
  - report
  - deploy
  - build_image

bmlx_test:
  image: harbor.bigo.sg/mlplat/bmlx-build:1.0.0  # test should use xdl version
  stage: test
  script:
    - pip uninstall enum34 -y && pip install pytest 
    - pip install . --user
    #- pip install --trusted-host 103.211.193.52 --extra-index-url http://103.211.193.52:8005/simple bmlx-metadata==1.0.1
    - python setup.py install --user
    - pip install --user -U pytest pytest-cov coverage
    - pytest bmlx
  coverage: '/TOTAL.*\s+(\d+%)$/'
  only:
    refs:
      - master
      - develop
      - merge_requests
  artifacts:
    paths:
      - build/coverage_report/
    expire_in: 1 day
  except:
    refs:
      - tags
  tags:
    - hk
    - k8s

pages:
  stage: report
  before_script: 
    - "true"
  script:
    - mkdir -p public/coverage
    - cp -rf build/coverage_report/* public/coverage
  only:
    refs:
      - master
  artifacts:
    paths:
      - public
  except:
    refs:
      - tags
  tags:
    - hk
    - k8s

pypi_deploy:
  stage: deploy
  image: ${image}
  script:
    - python setup.py sdist
    #- twine upload --verbose --skip-existing --repository-url http://103.211.193.52:8005/ dist/*
    - twine upload --verbose --skip-existing dist/*
  only:
    - /^(\d+\.)?(\d+\.)?(\*|\d+\.)?(\*|\d+)$/
  tags:
    - hk
    - k8s

bmlx_image:
  stage: build_image
  cache: {}
  script:
    - docker login "harbor.bigo.sg" -u "$HARBOR_USERNAME"  -p "$HARBOR_PASSWORD"
    - docker build --pull bmlx/external/ -f bmlx/external/Dockerfile -t harbor.bigo.sg/mlplat/bmlx:${CI_COMMIT_TAG} --build-arg BMLX_VERSION=${CI_COMMIT_TAG}    
    - docker push harbor.bigo.sg/mlplat/bmlx:${CI_COMMIT_TAG}

    # bmlx-develop 用于用户开发，避免开发机器没有 avx512 指令集，使用了 noavx512 image。 同时加入了ssh 支持
    - docker build --pull bmlx/external/ -f bmlx/external/Dockerfile.develop -t harbor.bigo.sg/mlplat/bmlx-develop:${CI_COMMIT_TAG} --build-arg BMLX_VERSION=${CI_COMMIT_TAG}
    - docker push harbor.bigo.sg/mlplat/bmlx-develop:${CI_COMMIT_TAG}
    - docker tag harbor.bigo.sg/mlplat/bmlx-develop:${CI_COMMIT_TAG} harbor.bigo.sg/mlplat/bmlx-develop:latest
    - docker push harbor.bigo.sg/mlplat/bmlx-develop:latest
  only:
    - /^(\d+\.)?(\d+\.)?(\*|\d+\.)?(\*|\d+)$/
  tags:
    - physical
    - avx512